name: Validate & Release

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (örn: v1.0.2)'
        required: false
        default: ''
      create_release:
        description: 'GitHub Release oluştur?'
        required: true
        type: boolean
        default: false

jobs:
  # ─────────────────────────────────────────────
  # 1. JSON Validation
  # ─────────────────────────────────────────────
  validate-json:
    name: Validate JSON
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Validate all JSON files
        run: |
          FAILED=0
          while IFS= read -r f; do
            if jq . "$f" > /dev/null 2>&1; then
              echo "OK: $f"
            else
              echo "FAIL: $f"; jq . "$f" 2>&1 || true; FAILED=1
            fi
          done < <(find data _pre_1_21_4 ./-1_21_4 1_21_6 -name "*.json" 2>/dev/null; echo "pack.mcmeta")
          [ $FAILED -ne 0 ] && { echo "FAILED: Invalid JSON files."; exit 1; } || echo "PASSED"

  # ─────────────────────────────────────────────
  # 2. pack.mcmeta Structural Validation
  # ─────────────────────────────────────────────
  validate-pack:
    name: Validate pack.mcmeta
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check pack_format and description
        run: |
          FAILED=0
          PF=$(jq '.pack.pack_format // empty' pack.mcmeta)
          [ -n "$PF" ] && echo "OK: pack_format = $PF" || { echo "FAIL: Missing pack_format"; FAILED=1; }
          DESC=$(jq '.pack.description // empty' pack.mcmeta)
          [ -n "$DESC" ] && echo "OK: description present" || { echo "FAIL: Missing description"; FAILED=1; }
          SF=$(jq '.pack.supported_formats // empty' pack.mcmeta)
          [ -n "$SF" ] && echo "OK: supported_formats = $SF" || true
          [ $FAILED -ne 0 ] && exit 1 || echo "PASSED"
      - name: Check overlay directories exist
        run: |
          FAILED=0
          while IFS= read -r dir; do
            [ -z "$dir" ] && continue
            [ -d "$dir" ] && echo "OK: $dir/" || { echo "FAIL: Missing overlay dir: $dir/"; FAILED=1; }
          done < <(jq -r '.overlays.entries[]?.directory // empty' pack.mcmeta 2>/dev/null)
          [ $FAILED -ne 0 ] && exit 1 || echo "PASSED"

  # ─────────────────────────────────────────────
  # 3. Function Reference Integrity
  # ─────────────────────────────────────────────
  validate-functions:
    name: Validate Function References
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check function tag references
        run: |
          FAILED=0
          while IFS= read -r tag_file; do
            while IFS= read -r ref; do
              [ -z "$ref" ] && continue
              [[ "$ref" == "#"* ]] && continue
              [[ "$ref" != *:* ]] && continue
              ns="${ref%%:*}"; path="${ref#*:}"
              found=0
              for base in . _pre_1_21_4 ./-1_21_4 1_21_6; do
                [ -f "$base/data/$ns/function/$path.mcfunction" ] && found=1 && break
              done
              [ $found -eq 1 ] && echo "OK: $ref" || { echo "FAIL: $tag_file -> $ref not found"; FAILED=1; }
            done < <(jq -r '.values[]? | if type == "object" then .id else . end' "$tag_file" 2>/dev/null)
          done < <(find data _pre_1_21_4 ./-1_21_4 1_21_6 -path "*/tags/function/*.json" 2>/dev/null)
          [ $FAILED -ne 0 ] && { echo "FAILED"; exit 1; } || echo "PASSED"
      - name: Check for empty .mcfunction files
        run: |
          EMPTY=0
          while IFS= read -r f; do
            content=$(grep -v '^[[:space:]]*#' "$f" | grep -v '^[[:space:]]*$' || true)
            [ -z "$content" ] && { echo "WARN: Empty: $f"; EMPTY=$((EMPTY+1)); }
          done < <(find data _pre_1_21_4 ./-1_21_4 1_21_6 -name "*.mcfunction" 2>/dev/null)
          [ $EMPTY -gt 0 ] && echo "WARN: $EMPTY empty files (may be intentional)" || echo "PASSED"

  # ─────────────────────────────────────────────
  # 4. Required Files Check
  # ─────────────────────────────────────────────
  validate-structure:
    name: Validate File Structure
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check required files and directories
        run: |
          FAILED=0
          for f in pack.mcmeta pack.png; do
            [ -f "$f" ] && echo "OK: $f" || { echo "FAIL: $f missing"; FAILED=1; }
          done
          for d in data _pre_1_21_4 ./-1_21_4 1_21_6; do
            [ -d "$d" ] && echo "OK: $d ($(find "$d" -type f | wc -l) files)" || { echo "FAIL: $d missing"; FAILED=1; }
          done
          for fn in "data/macro/function/load.mcfunction" "data/macro/function/tick.mcfunction" "data/minecraft/tags/function/load.json" "data/minecraft/tags/function/tick.json"; do
            [ -f "$fn" ] && echo "OK: $fn" || { echo "FAIL: $fn missing"; FAILED=1; }
          done
          [ $FAILED -ne 0 ] && { echo "FAILED"; exit 1; } || echo "PASSED"

  # ─────────────────────────────────────────────
  # 5. Version Validation
  # ─────────────────────────────────────────────
  validate-version:
    name: Validate Version
    runs-on: ubuntu-latest
    needs: [ validate-json, validate-pack, validate-functions, validate-structure ]
    steps:
      - uses: actions/checkout@v4
      - name: Read version from pack.mcmeta
        run: |
          RAW=$(jq -c '.' pack.mcmeta)
          VER=$(echo "$RAW" | grep -oP 'v\d+\.\d+\.\d+' | head -1 || true)
          [ -n "$VER" ] && echo "OK: pack.mcmeta version: $VER" || echo "WARN: No version found in pack.mcmeta"
      - name: Check version matches tag
        if: startsWith(github.ref, 'refs/tags/v') || (github.event_name == 'workflow_dispatch' && github.event.inputs.version != '')
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            TAG="${{ github.event.inputs.version }}"
          else
            TAG="${GITHUB_REF#refs/tags/}"
          fi
          TAG="${TAG#v}"
          RAW=$(jq -c '.' pack.mcmeta)
          if echo "$RAW" | grep -qP "v${TAG}"; then
            echo "PASSED: v$TAG matches pack.mcmeta"
          else
            echo "WARN: v$TAG not found in pack.mcmeta — update pack.mcmeta description before releasing"
          fi
      - name: Check CHANGELOG
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            TAG="${{ github.event.inputs.version }}"
          elif [[ "$GITHUB_REF" == refs/tags/* ]]; then
            TAG="${GITHUB_REF#refs/tags/}"
          else
            TAG=""
          fi
          [ ! -f "docs/CHANGELOG.md" ] && { echo "WARN: docs/CHANGELOG.md not found"; exit 0; }
          [ -z "$TAG" ] && { echo "INFO: No tag, skipping CHANGELOG check"; exit 0; }
          grep -q "$TAG" docs/CHANGELOG.md && echo "OK: $TAG in CHANGELOG" || echo "WARN: $TAG not in CHANGELOG"

  # ─────────────────────────────────────────────
  # 6. Package & Release
  # ─────────────────────────────────────────────
  release:
    name: Package & Release
    runs-on: ubuntu-latest
    needs: [ validate-json, validate-pack, validate-functions, validate-structure ]
    if: startsWith(github.ref, 'refs/tags/v') || (github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true')
    steps:
      - uses: actions/checkout@v4
      - name: Resolve release tag
        id: tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            TAG="${{ github.event.inputs.version }}"
            [ -z "$TAG" ] && { echo "FAIL: No version provided."; exit 1; }
          else
            TAG="${GITHUB_REF#refs/tags/}"
          fi
          echo "value=$TAG" >> $GITHUB_OUTPUT
          echo "OK: Release tag = $TAG"
      - name: Create git tag if manual run
        if: github.event_name == 'workflow_dispatch'
        run: |
          TAG="${{ steps.tag.outputs.value }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag "$TAG" || echo "WARN: Tag $TAG already exists, skipping"
          git push origin "$TAG" || echo "WARN: Could not push tag (may already exist)"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Build datapack ZIP
        id: build
        run: |
          TAG="${{ steps.tag.outputs.value }}"
          ZIP="macroEngine-${TAG}.zip"
          zip -r "$ZIP" data/ _pre_1_21_4/ ./-1_21_4/ 1_21_6/ pack.mcmeta pack.png
          echo "zip_name=$ZIP" >> $GITHUB_OUTPUT
          echo "OK: Built $ZIP ($(du -sh "$ZIP" | cut -f1))"
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.value }}
          name: "macroEngine ${{ steps.tag.outputs.value }}"
          files: ${{ steps.build.outputs.zip_name }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
